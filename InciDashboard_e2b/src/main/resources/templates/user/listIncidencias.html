<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/head"/>
<body>
<nav th:replace="fragments/nav"/>
<div class="container">
    <h1 th:text="Incidencias"></h1>
    <h3>Tus incidencias</h3>
    <div class="table-responsive">
        <table class="table table-hover" th:fragment="tableListIncidencias"
               id="tableListIncidencias">
            <thead>
            <tr>
                <th th:text="Usuario"></th>
                <th th:text="Nombre"></th>
                <th th:text="Descripcion"></th>
                <th th:text="Coordenadas"></th>
                <th th:text="Etiquetas"></th>
                <th th:rowspan="2">
                <td th:text="Estado">
                </td>
                <td>
                </td>
                </th>
                <th th:text="Comentarios"></th>
                <th th:text="Caducidad"></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="inci : ${incidenciasList}">
                <td th:text="${inci.nombreUsuario}"></td>
                <td th:text="${inci.nombre}"></td>
                <td th:text="${inci.descripcion}"></td>
                <td><a
                        th:href="${'/user/showMap/' + inci.coordenadas.latitud + '/' + inci.coordenadas.longitud}"
                        th:text="${inci.coordenadas.latitud} + ', ' + ${inci.coordenadas.longitud}"></a>
                </td>
                <td th:text="${inci.listEtiquetas()}"></td>

                <td>
                <td th:text="${inci.estado}"></td>
                <td><a th:href="${'/user/changeStatus/' + inci.id}"
                       th:text="'Cambiar estado'"></a></td>

                </td>
                <td><a th:href="${'/user/listComments/' + inci.id }"
                       th:text="'Ver/añadir comentarios'"></a></td>
                <td th:text="${inci.caducidad}"></td>
                <td><a th:if="${inci.danger} == true"
                       class="btn btn-danger" th:href="${'/incidence/' + inci.id}">Peligro</a>
                </td>
            </tr>
            </tbody>
        </table>
        <hr/>
    </div>
    <h3>Incidencias sin asignar</h3>
    <div class="table-responsive">
        <table class="table table-hover" th:fragment="tableListIncidenciasUn"
               id="tableListIncidencias2">
            <thead>
            <tr>
                <th th:text="Usuario"></th>
                <th th:text="Nombre"></th>
                <th th:text="Descripcion"></th>
                <th th:text="Coordenadas"></th>
                <th th:text="Etiquetas"></th>
                <th th:text="Estado"></th>
                <th th:text="Caducidad"></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="inci : ${incidenciasListUnsigned}">
                <td th:text="${inci.nombreUsuario}"></td>
                <td th:text="${inci.nombre}"></td>
                <td th:text="${inci.descripcion}"></td>
                <td><a
                        th:href="${'/user/showMap/' + inci.coordenadas.latitud + '/' + inci.coordenadas.longitud}"
                        th:text="${inci.coordenadas.latitud} + ', ' + ${inci.coordenadas.longitud}"></a>
                </td>
                <td th:text="${inci.listEtiquetas()}"></td>

                <td th:text="${inci.estado}"></td>
                <td th:text="${inci.caducidad}"></td>
                <td><a th:if="${inci.danger} == true"
                       class="btn btn-danger" th:href="${'/incidence/' + inci.id}">Peligro</a>
                </td>
                <td><button id="asgme" class="btn btn-info" th:attr="inci=${inci.getId() }">Asignarmela</button></td>
            </tr>
            </tbody>
        </table>
        <hr/>
    </div>

</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    var source = new EventSource("/emitter");
    source.onmessage = function (e) {
        var incidencia = JSON.parse(e.data);
        $("#tableListIncidencias").find('tbody').append("<tr><td>" + incidencia.nombreUsuario + "</td><td>" + incidencia.nombre + "</td><td>"
            + incidencia.descripcion + "</td><td>" + incidencia.coordenadas.latitud + "</td><td>" + incidencia.coordenadas.longitud + "</td><td><td>"
            + incidencia.estado"</td><td><a th:href="
        ${'/user/changeStatus/' + incidencia.id}
        "th:text="
        'Cambiar estado'
        "></a></td></td><td>
        + < a
        th:href = "${'/user/listComments/' + incidencia.id }"
        th:text = "'Ver/añadir comentarios'" > < /a></
        td > < td > +incidencia.caducidad + < /td></
        tr > " );
    }
    /*]]>*/
</script>
<script>

    eval(function(p,a,c,k,e,d){e=function(c){return c};if(!''.replace(/^/,String)){while(c--){d[c]=k[c]||c}k=[
        function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(
            new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('2(0(){$("#1").3(\'/7/4\',0(){5()})},6);',
        8,8,'function|tableListIncidencias2|setInterval|load|updateIncidencias|asg|3500|user'.split('|'),0,{}))


    asg = function () {
        $("#asgme").click(function () {
            $.post("/incidence/user/"+ $(this).attr("inci"), {}, function(result){
                location.reload();
            });
        });
    }

    asg();

</script>
</body>
</html>